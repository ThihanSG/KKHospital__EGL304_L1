<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Home - KKH</title>
  <link rel="stylesheet" href="/index.css">
  <style>
    .modal { 
      display: none; 
      position: fixed; 
      inset: 0; 
      align-items: center; 
      justify-content: center; 
      background: rgba(0,0,0,0.4); 
    }
    .modal .modal-content { 
      background: #fff; 
      padding: 20px; 
      border-radius: 8px; 
      width: 320px; 
    }
    .action-btn { margin: 6px; }
  </style>
</head>
<body>

<header class="topbar">
  <div class="container">
    <h2>KK Hospital</h2>
    <div class="account-info">
      <span id="username-display">Logged in as: <span id="user"></span></span>
      <a href="/logout" class="logout-btn" id="logout-btn">Logout</a>
    </div>
  </div>
</header>

<main class="main-content">
  <div class="tab-bar">
    <button class="tab-btn active" data-tab="schedule">Work Schedule</button>
    <button class="tab-btn" data-tab="create-user">Create Users</button>
    <button class="tab-btn" data-tab="view-users">View Users</button>
  </div>

  <!-- Schedule Tab -->
  <div id="tab-schedule" class="tab-section">
      <h1>Work Schedule</h1>
      <table class="schedule-table">
          <thead>
              <tr>
                  <th>Ward</th>
                  <th>Nurse In-Charge</th>
                  <th>Patients Assigned</th>
                  <th>Workload Quota</th>
              </tr>
          </thead>
          <tbody>
              <tr>
                  <td>Ward 3A</td>
                  <td>Nur Aisyah</td>
                  <td>
                      • Patient 001 Sarah Lim<br>
                      • Patient 014 Megan Tan
                  </td>
                  <td>2 / 5</td>
              </tr>
              <tr>
                  <td>Ward 4B</td>
                  <td>John Lee</td>
                  <td>
                      • Patient 007 Ahmad Rahim<br>
                      • Patient 021 Chloe Ng<br>
                      • Patient 030 Lucas Wong
                  </td>
                  <td>3 / 5</td>
              </tr>
              <tr>
                  <td>Ward 2C</td>
                  <td>Lim Jia Wen</td>
                  <td>
                      • Patient 012 Tan Wei<br>
                      • Patient 088 Siti Nur<br>
                  </td>
                  <td>2 / 5</td>
              </tr>
          </tbody>
      </table>
  </div>

  <!-- Create User Tab -->
  <div id="tab-create-user" class="tab-section" style="display:none;">
    <h1>Create User</h1>
    <form class="create-user-form">
      <div class="input-group"><label>Username</label><input id="new-username" required></div>
      <div class="input-group"><label>Password</label><input id="new-password" type="password" required></div>
      <div class="input-group">
        <label>Role</label>
        <select id="user-role" required>
          <option value="" disabled selected>Select role</option>
          <option>Administrator</option>
          <option>User</option>
        </select>
      </div>
      <button type="submit" class="action-btn">Create User</button>
    </form>
  </div>

  <!-- View Users Tab -->
  <div id="tab-view-users" class="tab-section" style="display:none;">
    <h1>All Users</h1>
    <table class="users-table">
      <thead><tr><th>Username</th><th>Role</th><th>Actions</th></tr></thead>
      <tbody id="users-list"></tbody>
    </table>
  </div>

  <!-- Update Modal -->
  <div id="update-user-modal" class="modal" aria-hidden="true">
    <div class="modal-content">
      <h3>Update User</h3>

      <form id="update-user-form">
        <div class="input-group">
          <label for="update-username">Username</label>
          <input type="text" id="update-username" readonly>
        </div>

        <div class="input-group">
          <label for="update-role">Role</label>
          <select id="update-role">
            <option>Administrator</option>
            <option>User</option>
          </select>
        </div>

        <div class="modal-buttons">
          <button type="submit" class="btn-save">Save</button>
          <button type="button" id="cancel-update" class="btn-cancel">Cancel</button>
        </div>
      </form>
    </div>
  </div>

</main>

<script>
  // -------------------------
  // Popup helper
  // -------------------------
  function showPopup(msg, type = "info") {
    const d = document.createElement("div");
    d.textContent = msg;
    d.className = `popup ${type}`;
    document.body.appendChild(d);
    setTimeout(() => d.remove(), 2500);
  }

  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
  }

  document.getElementById('user').innerText = getCookie('user3030') || 'Unknown';

  // -------------------------
  // Tab Switching
  // -------------------------
  const tabButtons = document.querySelectorAll(".tab-btn");
  const tabSections = document.querySelectorAll(".tab-section");

  tabButtons.forEach(btn => btn.addEventListener("click", () => {
    const target = btn.dataset.tab;

    tabButtons.forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    tabSections.forEach(s => {
      s.style.display = s.id === `tab-${target}` ? "block" : "none";
    });

    if (target === "view-users") loadUsers();
  }));

  // -------------------------
  // Create User
  // -------------------------
  document.querySelector(".create-user-form").addEventListener("submit", async e => {
    e.preventDefault();
    const username = document.getElementById("new-username").value.trim();
    const password = document.getElementById("new-password").value;
    const role = document.getElementById("user-role").value;

    if (!username || !password || !role) {
      showPopup("Please fill in all fields.", "error");
      return;
    }

    try {
      const res = await fetch("/create-user", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ username, password, role })
      });

      const data = await res.json();
      if (data.success) {
        showPopup("User created!", "success");
        e.target.reset();
      } else {
        showPopup("Error: " + data.message, "error");
      }
    } catch (err) {
      showPopup("Server error: " + err.message, "error");
    }
  });

  // -------------------------
  // Load Users
  // -------------------------
  async function loadUsers() {
    try {
      const res = await fetch("/users");
      const data = await res.json();

      if (!data.success) {
        showPopup("Unauthorized or failed to load users", "error");
        return;
      }

      const tbody = document.getElementById("users-list");
      tbody.innerHTML = "";

      data.users.forEach(u => {
        const tr = document.createElement("tr");

        const tdName = document.createElement("td");
        tdName.innerText = u.username;

        const tdRole = document.createElement("td");
        tdRole.innerText = u.role;

        const tdActions = document.createElement("td");

        const btnUpdate = document.createElement("button");
        btnUpdate.className = "btn-update";
        btnUpdate.innerText = "Update";
        btnUpdate.dataset.username = u.username;
        btnUpdate.dataset.role = u.role;
        btnUpdate.addEventListener("click", showUpdatePopup);

        const btnDelete = document.createElement("button");
        btnDelete.className = "btn-remove";
        btnDelete.innerText = "Delete";
        btnDelete.dataset.username = u.username;
        btnDelete.addEventListener("click", deleteUser);

        tdActions.append(btnUpdate, " ", btnDelete);

        tr.append(tdName, tdRole, tdActions);
        tbody.appendChild(tr);
      });
    } catch (err) {
      showPopup("Error loading users: " + err.message, "error");
    }
  }

  // -------------------------
  // Delete User
  // -------------------------
  async function deleteUser(e) {
    const username = e.currentTarget.dataset.username;
    if (!confirm(`Delete ${username}?`)) return;

    try {
      const res = await fetch("/delete-user", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ username })
      });

      const data = await res.json();

      if (data.success) {
        showPopup("Deleted", "success");
        loadUsers();
      } else {
        showPopup("Error: " + data.message, "error");
      }

    } catch (err) {
      showPopup("Server error: " + err.message, "error");
    }
  }

  // -------------------------
  // Update Modal Logic
  // -------------------------
  const updateModal = document.getElementById("update-user-modal");
  const updateForm = document.getElementById("update-user-form");
  const cancelUpdateBtn = document.getElementById("cancel-update");

  function showUpdatePopup(e) {
    const btn = e.currentTarget;
    const username = btn.dataset.username;
    const role = btn.dataset.role;

    updateForm.dataset.originalUsername = username;

    document.getElementById("update-username").value = username;
    document.getElementById("update-role").value = role;

    updateModal.style.display = "flex";
  }

  cancelUpdateBtn.addEventListener("click", () => {
    updateModal.style.display = "none";
  });

  updateForm.addEventListener("submit", async e => {
    e.preventDefault();
    const originalUsername = updateForm.dataset.originalUsername;
    const role = document.getElementById("update-role").value;

    try {
      const res = await fetch("/update-user", {
        method: "POST",
        headers: {"Content-Type":"application/json"},
        body: JSON.stringify({ username: originalUsername, role })
      });

      const data = await res.json();

      if (data.success) {
        showPopup("User updated!", "success");
        updateModal.style.display = "none";
        loadUsers();
      } else {
        showPopup("Error: " + data.message, "error");
      }

    } catch (err) {
      showPopup("Server error: " + err.message, "error");
    }
  });

  // ------------------------------
  // ROLE-BASED PERMISSION CONTROL
  // ------------------------------
  async function applyRolePermissions() {
    try {
      const res = await fetch("/status");
      const data = await res.json();
      const role = data.role;

      const btnCreate = document.querySelector('[data-tab="create-user"]');
      const btnView = document.querySelector('[data-tab="view-users"]');

      const sectionCreate = document.getElementById("tab-create-user");
      const sectionView = document.getElementById("tab-view-users");

      if (role !== "Administrator") {
        btnCreate.style.display = "none";
        btnView.style.display = "none";

        sectionCreate.style.display = "none";
        sectionView.style.display = "none";

        // Force schedule tab as active
        document.querySelector('[data-tab="schedule"]').click();
      }
    } catch (err) {
      console.error("Role permission failed:", err);
    }
  }

  // Run after DOM loads
  applyRolePermissions();

</script>
</body>
</html>
